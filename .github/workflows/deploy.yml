name: Full-Stack Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------
  # JOB 1: BACKEND
  # ------------------------------------------------------------------
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Test Docker Build
        run: |
          cd backend
          docker build . -t test-build
          echo "Docker build successful!"

      # This step fixes the "command not found" error
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install HF Hub
        run: pip install huggingface_hub

      # FIXED: Uses Python directly to upload (bypasses PATH issues)
      - name: Push Backend to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: mubashir751/taskera-ai-backend 
        run: |
          python -c "from huggingface_hub import HfApi; import os; HfApi().upload_folder(folder_path='./backend', repo_id=os.environ['HF_SPACE_ID'], repo_type='space', token=os.environ['HF_TOKEN'], path_in_repo='.')"

  # ------------------------------------------------------------------
  # JOB 2: FRONTEND
  # ------------------------------------------------------------------
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      # FIXED: Explicitly cd into frontend and run deploy from there
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd frontend
          vercel deploy --prod --token=$VERCEL_TOKEN --yes